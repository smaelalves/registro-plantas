<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Visualização de Dados da Planta</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    #qr-reader { width: 300px; margin-bottom: 20px; }
    canvas { max-width: 600px; }
  </style>
</head>
<body>
  <h2>Visualização de Dados da Planta</h2>

  <div id="qr-reader"></div>
  <p><strong>Código da planta escaneado:</strong> <span id="codigoDisplay">Nenhum</span></p>

  <div id="dados"></div>
  <canvas id="grafico"></canvas>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyByIpGG2Blw0hRUmyPXqal10M_R2ZwI9bg",
      authDomain: "monitoramento-plantas.firebaseapp.com",
      databaseURL: "https://monitoramento-plantas-default-rtdb.firebaseio.com",
      projectId: "monitoramento-plantas",
      storageBucket: "monitoramento-plantas.firebasestorage.app",
      messagingSenderId: "1020939163682",
      appId: "1:1020939163682:web:b27eb35d04b080fc2fd27b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function exibirDados(codigo) {
      document.getElementById("codigoDisplay").innerText = codigo;

      // Lê o nó da planta
      const plantaRef = db.ref("plantas/" + codigo);
      plantaRef.once("value")
        .then((snapshot) => {
          const dados = snapshot.val();
          if (!dados) {
            document.getElementById("dados").innerHTML = "<p>Nenhum dado encontrado para esse código.</p>";
            return;
          }

          // Exibir os dados
          document.getElementById("dados").innerHTML = `
            <p><strong>Tamanho:</strong> ${dados.tamanho} cm</p>
            <p><strong>Data da última coleta:</strong> ${dados.dataColeta}</p>
          `;

          // Exemplo de dados de coleta para gráfico
          // Neste exemplo simples, só temos uma coleta — para ter várias, precisaria salvar como histórico
          const datas = [dados.dataColeta];
          const tamanhos = [parseFloat(dados.tamanho)];

          const ctx = document.getElementById("grafico").getContext("2d");
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: datas,
              datasets: [{
                label: 'Crescimento da Planta (cm)',
                data: tamanhos,
                borderColor: 'green',
                backgroundColor: 'lightgreen',
                fill: true,
                tension: 0.2
              }]
            },
            options: {
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        })
        .catch((err) => {
          console.error("Erro ao buscar dados:", err);
        });
    }

    window.addEventListener("load", () => {
      const scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
      scanner.render((decodedText) => {
        exibirDados(decodedText);
        scanner.clear();
      });
    });
  </script>
</body>
</html>
